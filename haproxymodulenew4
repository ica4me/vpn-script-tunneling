global
  tune.ssl.default-dh-param 2048
  tune.h2.initial-window-size 2147483647
  tune.bufsize 131702
  tune.maxrewrite 32768
  maxconn 1000000

defaults 
  option httplog
  option tcplog
  option redispatch
  option forwardfor
  option tcpka
  option dontlognull
  option http-server-close

  timeout client-fin 1s
  timeout server-fin 1s
  timeout connect 15s
  timeout client 15s
  timeout server 24h
  timeout tunnel 24h
  
frontend my_listen
  bind :::80 tfo
  bind :::443 tfo
  bind :::8080 tfo
  bind :::8443 tfo
  bind :::8880 tfo
  bind :::2202 tfo
  tcp-request inspect-delay 500ms
  tcp-request content accept if { req.ssl_hello_type 1 }
  
  acl this_payload payload(0,7) -m bin 5353482d322e30
  acl len_zero req.len 0
  acl path_panel path_reg -i ^\/vps\/(.*)
  acl path_panel1 path_reg -i ^\/forallsc\/(.*)
  acl path_panel2 path_reg -i ^\/botosc\/(.*)
  acl path_all path_reg -i ^\/(.*)
  acl redir_ssl req_ssl_sni -m found
  
  use_backend this_ssl if redir_ssl
  use_backend payload_data if this_payload
  use_backend panel if path_panel
  use_backend panel1 if path_panel1
  use_backend panel2 if path_panel2
  use_backend read_reg if path_all
  use_backend no_Length if len_zero
  
frontend ssl
  bind abns@haproxy-pipe-ssl tfo accept-proxy ssl crt /usr/sbin/potatonc/cert/cert.pem alpn h2,http/1.1
  tcp-request inspect-delay 500ms
  tcp-request content accept if { req.ssl_hello_type 1 }
  
  acl this_payload payload(0,7) -m bin 5353482d322e30
  acl len_zero req.len 0
  acl path_panel path_reg -i ^\/vps\/(.*)
  acl path_panel1 path_reg -i ^\/forallsc\/(.*)
  acl path_panel2 path_reg -i ^\/botosc\/(.*)
  acl path_all path_reg -i ^\/(.*)
  acl conn_h2 ssl_fc_alpn -i h2
  
  use_backend panel if path_panel conn_h2
  use_backend panel1 if path_panel1 conn_h2
  use_backend panel2 if path_panel2 conn_h2
  use_backend h2connect if conn_h2
  use_backend payload_data if this_payload
  use_backend panel if path_panel
  use_backend panel1 if path_panel1
  use_backend panel2 if path_panel2
  use_backend read_reg if path_all
  use_backend no_Length if len_zero

frontend proxy
  bind abns@haproxy-pipe-proxy tfo accept-proxy
  tcp-request inspect-delay 500ms
  tcp-request content accept if { req.ssl_hello_type 1 }
  
  acl path_vmess path_reg -i ^\/vm(.*)
  acl path_upvm path_reg -i ^\/upvm(.*)
  acl path_vless path_reg -i ^\/vl(.*)
  acl path_upvl path_reg -i ^\/upvl(.*)
  acl path_trojan path_reg -i ^\/tr(.*)
  acl path_uptr path_reg -i ^\/uptr(.*)
  acl path_ssh path_reg -i ^\/ssh(.*)
  acl path_ssh1 path -i /
  acl path_sshtra path_reg -i ^\/(.*)\/tra(.*)
  acl path_ssh2 path_reg -i ^\/(.*)\/ssh(.*)
  acl path_ovpn path_reg -i ^\/ovpn(.*)
  acl path_ovpn2 path_reg -i ^\/(.*)\/ovpn(.*)
  acl path_vless2 path_reg -i ^\/(.*)\/vl(.*)
  acl path_trojan2 path_reg -i ^\/(.*)\/tro(.*)
  acl path_vmess2 path_reg -i ^\/(.*)
  
  use_backend vmess if path_vmess
  use_backend vless if path_vless
  use_backend trojan if path_trojan
  use_backend to_ng if path_ssh
  use_backend to_ng if path_ssh1
  use_backend to_ng if path_sshtra
  use_backend to_ng if path_ssh2
  use_backend vless if path_vless2
  use_backend trojan if path_trojan2
  use_backend upvm if path_upvm
  use_backend upvl if path_upvl
  use_backend uptr if path_uptr
  use_backend vmess if path_vmess2

frontend listen_sv
  bind :::2082 tfo
  bind :::2083 tfo
  tcp-request inspect-delay 500ms
  tcp-request content accept if { req.ssl_hello_type 1 }
  
  acl this_payload payload(0,7) -m bin 5353482d322e30
  acl len_zero req.len 0
  acl path_all path_reg -i ^\/(.*)
  acl redir_ssl req_ssl_sni -m found
  
  use_backend ssl_sv if redir_ssl
  use_backend payload_data if this_payload
  use_backend no_Length if len_zero
  use_backend to_ng if path_all

frontend listen_sv_ssl
  bind abns@haproxy-pipe-ssl-sv tfo accept-proxy ssl crt /usr/sbin/potatonc/cert/cert.pem alpn h2,http/1.1
  tcp-request inspect-delay 500ms
  tcp-request content accept if { req.ssl_hello_type 1 }
  
  acl this_payload payload(0,7) -m bin 5353482d322e30
  acl len_zero req.len 0
  acl path_all path_reg -i ^\/(.*)
  
  use_backend payload_data if this_payload
  use_backend no_Length if len_zero
  use_backend to_ng if path_all

frontend listen_xr
  bind :::2052 tfo
  bind :::2053 tfo
  tcp-request inspect-delay 500ms
  tcp-request content accept if { req.ssl_hello_type 1 }
  
  acl path_all path_reg -i ^\/(.*)
  acl redir_ssl req_ssl_sni -m found
  
  use_backend ssl_xr if redir_ssl
  use_backend read_reg_xr if path_all

frontend listen_xr_ssl
  bind abns@haproxy-pipe-ssl-xr tfo accept-proxy ssl crt /usr/sbin/potatonc/cert/cert.pem alpn h2,http/1.1
  tcp-request inspect-delay 500ms
  tcp-request content accept if { req.ssl_hello_type 1 }
  
  acl path_all path_reg -i ^\/(.*)
  acl conn_h2 ssl_fc_alpn -i h2
  
  use_backend h2connect if conn_h2
  use_backend read_reg_xr if path_all

frontend proxy_xr
  bind abns@haproxy-pipe-proxy-xr tfo accept-proxy
  tcp-request inspect-delay 500ms
  tcp-request content accept if { req.ssl_hello_type 1 }
  
  acl path_vmess path_reg -i ^\/vm(.*)
  acl path_upvm path_reg -i ^\/upvm(.*)
  acl path_vless path_reg -i ^\/vl(.*)
  acl path_upvl path_reg -i ^\/upvl(.*)
  acl path_trojan path_reg -i ^\/tr(.*)
  acl path_uptr path_reg -i ^\/uptr(.*)
  acl path_vless2 path_reg -i ^\/(.*)\/vl(.*)
  acl path_trojan2 path_reg -i ^\/(.*)\/tro(.*)
  acl path_vmess2 path_reg -i ^\/(.*)
  
  use_backend vmess if path_vmess
  use_backend vless if path_vless
  use_backend trojan if path_trojan
  use_backend vless if path_vless2
  use_backend trojan if path_trojan2
  use_backend upvm if path_upvm
  use_backend upvl if path_upvl
  use_backend uptr if path_uptr
  use_backend vmess if path_vmess2


frontend from_ng
  bind 127.0.0.1:1229 tfo
  tcp-request inspect-delay 500ms
  tcp-request content accept if { req.ssl_hello_type 1 }
  
  acl this_payload payload(0,7) -m bin 5353482d322e30
  acl len_zero req.len 0
  
  use_backend payload_data2 if this_payload
  use_backend no_Length if len_zero


backend read_reg
  server localhost abns@haproxy-pipe-proxy send-proxy check

backend read_reg_xr
  server localhost abns@haproxy-pipe-proxy-xr send-proxy check

backend this_ssl
  server localhost abns@haproxy-pipe-ssl send-proxy check

backend ssl_sv
  server localhost abns@haproxy-pipe-ssl-sv send-proxy check

backend ssl_xr
  server localhost abns@haproxy-pipe-ssl-xr send-proxy check


backend vmess
  mode http
  acl from_cf src -f /usr/sbin/potatonc/p0t4t0.lst
  acl cf_ip_hdr req.hdr(CF-Connecting-IP) -m found
  http-request set-header X-Forwarded-For %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr
  http-request set-header X-Forwarded-For %[src] if !from_cf !cf_ip_hdr
  http-request set-header X-Real-IP %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr
  http-request set-header X-Real-IP %[src] if !from_cf !cf_ip_hdr
  http-request replace-path /(.*) /worryfree
  server localhost 127.0.0.1:55

backend vless
  mode http
  acl from_cf src -f /usr/sbin/potatonc/p0t4t0.lst
  acl cf_ip_hdr req.hdr(CF-Connecting-IP) -m found
  http-request set-header X-Forwarded-For %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr
  http-request set-header X-Forwarded-For %[src] if !from_cf !cf_ip_hdr
  http-request set-header X-Real-IP %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr
  http-request set-header X-Real-IP %[src] if !from_cf !cf_ip_hdr
  http-request replace-path /(.*) /worryfree
  server localhost 127.0.0.1:58

backend trojan
  mode http
  acl from_cf src -f /usr/sbin/potatonc/p0t4t0.lst
  acl cf_ip_hdr req.hdr(CF-Connecting-IP) -m found
  http-request set-header X-Forwarded-For %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr
  http-request set-header X-Forwarded-For %[src] if !from_cf !cf_ip_hdr
  http-request set-header X-Real-IP %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr
  http-request set-header X-Real-IP %[src] if !from_cf !cf_ip_hdr
  http-request replace-path /(.*) /trojan
  server localhost 127.0.0.1:1060

backend h2connect
  mode http
  acl from_cf src -f /usr/sbin/potatonc/p0t4t0.lst
  acl cf_ip_hdr req.hdr(CF-Connecting-IP) -m found
  http-request set-header X-Forwarded-For %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr
  http-request set-header X-Forwarded-For %[src] if !from_cf !cf_ip_hdr
  http-request set-header X-Real-IP %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr
  http-request set-header X-Real-IP %[src] if !from_cf !cf_ip_hdr
  server localhost 127.0.0.1:9605 proto h2 send-proxy check

backend upvm
  acl from_cf src -f /usr/sbin/potatonc/p0t4t0.lst
  acl cf_ip_hdr req.hdr(CF-Connecting-IP) -m found
  http-request set-header X-Forwarded-For %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr
  http-request set-header X-Forwarded-For %[src] if !from_cf !cf_ip_hdr
  http-request set-header X-Real-IP %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr
  http-request set-header X-Real-IP %[src] if !from_cf !cf_ip_hdr
  server localhost 127.0.0.1:54 send-proxy check

backend upvl
  acl from_cf src -f /usr/sbin/potatonc/p0t4t0.lst
  acl cf_ip_hdr req.hdr(CF-Connecting-IP) -m found
  http-request set-header X-Forwarded-For %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr
  http-request set-header X-Forwarded-For %[src] if !from_cf !cf_ip_hdr
  http-request set-header X-Real-IP %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr
  http-request set-header X-Real-IP %[src] if !from_cf !cf_ip_hdr
  server localhost 127.0.0.1:57 send-proxy check

backend uptr
  acl from_cf src -f /usr/sbin/potatonc/p0t4t0.lst
  acl cf_ip_hdr req.hdr(CF-Connecting-IP) -m found
  http-request set-header X-Forwarded-For %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr
  http-request set-header X-Forwarded-For %[src] if !from_cf !cf_ip_hdr
  http-request set-header X-Real-IP %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr
  http-request set-header X-Real-IP %[src] if !from_cf !cf_ip_hdr
  server localhost 127.0.0.1:1062 send-proxy check


backend to_ng
  acl from_cf src -f /usr/sbin/potatonc/p0t4t0.lst
  acl cf_ip_hdr req.hdr(CF-Connecting-IP) -m found
  http-request set-header X-Forwarded-For %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr
  http-request set-header X-Forwarded-For %[src] if !from_cf !cf_ip_hdr
  http-request set-header X-Real-IP %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr
  http-request set-header X-Real-IP %[src] if !from_cf !cf_ip_hdr
  server localhost 127.0.0.1:2996 send-proxy check

backend no_Length
  mode tcp
  acl from_cf src -f /usr/sbin/potatonc/p0t4t0.lst
  acl cf_ip_hdr req.hdr(CF-Connecting-IP) -m found
  http-request set-header X-Forwarded-For %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr
  http-request set-header X-Forwarded-For %[src] if !from_cf !cf_ip_hdr
  http-request set-header X-Real-IP %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr
  http-request set-header X-Real-IP %[src] if !from_cf !cf_ip_hdr
  server localhost 127.0.0.1:1194

backend payload_data
  mode tcp
  balance roundrobin
  acl from_cf src -f /usr/sbin/potatonc/p0t4t0.lst
  acl cf_ip_hdr req.hdr(CF-Connecting-IP) -m found
  http-request set-header X-Forwarded-For %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr
  http-request set-header X-Forwarded-For %[src] if !from_cf !cf_ip_hdr
  http-request set-header X-Real-IP %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr
  http-request set-header X-Real-IP %[src] if !from_cf !cf_ip_hdr
  server localhost-bitbucket-ssh 127.0.0.1:2222
  server localhost               127.0.0.1:90

backend payload_data2
  mode tcp
  acl from_cf src -f /usr/sbin/potatonc/p0t4t0.lst
  acl cf_ip_hdr req.hdr(CF-Connecting-IP) -m found
  http-request set-header X-Forwarded-For %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr
  http-request set-header X-Forwarded-For %[src] if !from_cf !cf_ip_hdr
  http-request set-header X-Real-IP %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr
  http-request set-header X-Real-IP %[src] if !from_cf !cf_ip_hdr
  server localhost               127.0.0.1:90

backend panel
  mode http
  acl from_cf src -f /usr/sbin/potatonc/p0t4t0.lst
  acl cf_ip_hdr req.hdr(CF-Connecting-IP) -m found
  http-request set-header X-Forwarded-For %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr
  http-request set-header X-Forwarded-For %[src] if !from_cf !cf_ip_hdr
  http-request set-header X-Real-IP %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr
  http-request set-header X-Real-IP %[src] if !from_cf !cf_ip_hdr
  server localhost /var/run/api.sock

backend panel1
  mode http
  acl from_cf src -f /usr/sbin/potatonc/p0t4t0.lst
  acl cf_ip_hdr req.hdr(CF-Connecting-IP) -m found
  http-request set-header X-Forwarded-For %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr
  http-request set-header X-Forwarded-For %[src] if !from_cf !cf_ip_hdr
  http-request set-header X-Real-IP %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr
  http-request set-header X-Real-IP %[src] if !from_cf !cf_ip_hdr
  server localhost /var/run/api.sock

backend panel2
  mode http
  acl from_cf src -f /usr/sbin/potatonc/p0t4t0.lst
  acl cf_ip_hdr req.hdr(CF-Connecting-IP) -m found
  http-request set-header X-Forwarded-For %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr
  http-request set-header X-Forwarded-For %[src] if !from_cf !cf_ip_hdr
  http-request set-header X-Real-IP %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr
  http-request set-header X-Real-IP %[src] if !from_cf !cf_ip_hdr
  server localhost /var/run/api.sock
